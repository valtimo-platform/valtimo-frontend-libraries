<!--
  ~ Copyright 2015-2020 Ritense BV, the Netherlands.
  ~
  ~ Licensed under EUPL, Version 1.2 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~ https://joinup.ec.europa.eu/collection/eupl/eupl-text-eupl-12
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" basis,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<ibm-sidenav
  *ngIf="{
    sideBarExpanded: sideBarExpanded$ | async,
    closestSequence: closestSequence$ | async
  } as obs"
  [allowExpansion]="false"
  [expanded]="obs.sideBarExpanded"
>
  <ng-container *ngFor="let menuItem of menuItems$ | async">
    <ng-container *ngIf="!menuItem.children">
      <ng-container
        *ngTemplateOutlet="
          topMenuItem;
          context: {menuItem: menuItem, closestSequence: obs.closestSequence}
        "
      ></ng-container>
    </ng-container>
    <ng-container *ngIf="menuItem.children">
      <ng-container
        *ngTemplateOutlet="
          topMenuItem;
          context: {menuItem: menuItem, closestSequence: obs.closestSequence}
        "
      ></ng-container>
      <ng-container *ngTemplateOutlet="subMenuIcon; context: {menuItem: menuItem}"></ng-container>
      <ibm-sidenav-menu [title]="menuItem | menuItemTranslate | async">
        <ng-container *ngFor="let childMenuItem of menuItem.children">
          <ibm-sidenav-item
            *ngIf="childMenuItem.link"
            (click)="navigateToRoute(childMenuItem.link)"
            [active]="'' + menuItem.sequence + childMenuItem.sequence === obs.closestSequence"
          >
            <valtimo-menu-item-text [menuItem]="childMenuItem"></valtimo-menu-item-text>
          </ibm-sidenav-item>
        </ng-container>
      </ibm-sidenav-menu>
    </ng-container>
  </ng-container>
</ibm-sidenav>

<ng-template #subMenuIcon let-menuItem="menuItem">
  <div class="menu-item-icon-container"><i class="{{ menuItem.iconClass }}"></i></div>
</ng-template>

<ng-template #topMenuItem let-menuItem="menuItem" let-closestSequence="closestSequence">
  <ibm-sidenav-item
    (click)="navigateToRoute(menuItem.link)"
    *ngIf="!menuItem.children"
    [active]="'' + menuItem.sequence === closestSequence"
    [ngClass]="{
      'menu-item--hidden': menuItem.includeFunction !== undefined,
      'menu-item--visible':
        menuItem.includeFunction !== undefined &&
        (includeFunctionObservables[menuItem.title] | async)
    }"
  >
    <valtimo-menu-item-text [menuItem]="menuItem"></valtimo-menu-item-text>
  </ibm-sidenav-item>
</ng-template>
