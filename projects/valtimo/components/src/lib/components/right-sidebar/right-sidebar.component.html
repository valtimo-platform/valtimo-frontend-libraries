<!--
  ~ Copyright 2015-2020 Ritense BV, the Netherlands.
  ~
  ~ Licensed under EUPL, Version 1.2 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~ https://joinup.ec.europa.eu/collection/eupl/eupl-text-eupl-12
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" basis,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<div class="right-sidebar-menu">
  <ibm-panel [expanded]="panelExpanded$ | async">
    <div ibmGrid [condensed]="true">
      <div ibmRow>
        <div ibmCol [columnNumbers]="{lg: 16}" class="menu-tabs">
          <ibm-tabs class="cds--tab--list--full-width">
            <ibm-tab [heading]="'account.title' | translate">
              <ng-container *ngTemplateOutlet="accountTabTemplate"></ng-container>
            </ibm-tab>
            <ibm-tab [heading]="'settings.title' | translate">
              <ng-container *ngTemplateOutlet="settingsTabTemplate"></ng-container>
            </ibm-tab>
          </ibm-tabs>
        </div>
      </div>
    </div>
  </ibm-panel>
</div>

<ng-template #accountTabTemplate>
  <ng-container *ngTemplateOutlet="accountInformationTemplate"></ng-container>
  <ng-container *ngTemplateOutlet="contextTemplate"></ng-container>
  <ng-container *ngTemplateOutlet="linksTemplate"></ng-container>
</ng-template>

<ng-template #settingsTabTemplate>
  <ng-container *ngTemplateOutlet="languageSettingsTemplate"></ng-container>
  <ng-container *ngTemplateOutlet="notificationSettingsTemplate"></ng-container>
  <ng-container *ngTemplateOutlet="versionTemplate"></ng-container>
</ng-template>

<ng-template #accountInformationTemplate>
  <ibm-structured-list>
    <ibm-list-header>
      <ibm-list-column>{{ 'account.informationTitle' | translate }}</ibm-list-column>
    </ibm-list-header>
    <ibm-list-row>
      <ibm-list-column>
        <ng-container *ngTemplateOutlet="accountInformationTableTemplate"></ng-container>
      </ibm-list-column>
    </ibm-list-row>
  </ibm-structured-list>
</ng-template>

<ng-template #accountInformationTableTemplate>
  <div class="information-table account-information">
    <ibm-structured-list *ngIf="userSubject$ | async as userSubject">
      <ibm-list-row>
        <ibm-list-column
          >{{ 'interface.email' | translate }}
          <ibm-tag type="blue">{{ userSubject.email }}</ibm-tag>
        </ibm-list-column>
      </ibm-list-row>
      <ibm-list-row>
        <ibm-list-column
          >{{ 'interface.username' | translate }}
          <ibm-tag type="blue">{{ userSubject.username }}</ibm-tag>
        </ibm-list-column>
      </ibm-list-row>
      <ibm-list-row>
        <ibm-list-column
          >{{ 'interface.name' | translate }}
          <ibm-tag type="blue">{{ userSubject.firstName + ' ' + userSubject.lastName }}</ibm-tag>
        </ibm-list-column>
      </ibm-list-row>
    </ibm-structured-list>
  </div>
</ng-template>

<ng-template #contextTemplate>
  <ng-container
    *ngIf="{userContexts: userContexts$ | async, activeContext: activeContext$ | async} as obs"
  >
    <ibm-structured-list *ngIf="obs.userContexts?.length > 1 && obs.activeContext?.id">
      <ibm-list-header>
        <ibm-list-column>{{ 'settings.context.title' | translate }}</ibm-list-column>
      </ibm-list-header>
      <ibm-list-row>
        <ibm-list-column>
          <ibm-select [ngModel]="obs.activeContext?.id" (ngModelChange)="setUserContext($event)">
            <option *ngFor="let context of obs.userContexts" [value]="context.id">
              {{ context.name }}
            </option>
          </ibm-select>
        </ibm-list-column>
      </ibm-list-row>
    </ibm-structured-list>
  </ng-container>
</ng-template>

<ng-template #linksTemplate>
  <ibm-structured-list>
    <ibm-list-header>
      <ibm-list-column>{{ 'account.quickLinks' | translate }}</ibm-list-column>
    </ibm-list-header>
    <ibm-list-row>
      <ibm-list-column>
        <ng-container *ngTemplateOutlet="linksTableTemplate"></ng-container>
      </ibm-list-column>
    </ibm-list-row>
  </ibm-structured-list>
</ng-template>

<ng-template #linksTableTemplate>
  <div class="information-table">
    <ibm-structured-list>
      <ibm-list-row>
        <ibm-list-column>
          <a href="https://docs.valtimo.nl" target="_blank" ibmLink>{{
            'account.links.help' | translate
          }}</a>
        </ibm-list-column>
      </ibm-list-row>
      <ibm-list-row>
        <ibm-list-column>
          <a href="https://www.valtimo.nl/feedback" target="_blank" ibmLink>{{
            'account.links.feedback' | translate
          }}</a>
        </ibm-list-column>
      </ibm-list-row>
      <ibm-list-row>
        <ibm-list-column>
          <a href="https://forum.valtimo.nl" target="_blank" ibmLink>{{
            'account.links.forum' | translate
          }}</a>
        </ibm-list-column>
      </ibm-list-row>
      <ibm-list-row>
        <ibm-list-column>
          <a href="javascript:void(0)" ibmLink (click)="logout()">{{
            'account.plantATreeMailBody' | translate
          }}</a>
        </ibm-list-column>
      </ibm-list-row>
      <ibm-list-row *ngIf="showPlantATreeButton">
        <ibm-list-column>
          <a
            class="text-success"
            href="mailto:valtimo@ritense.com?{{ 'account.plantATreeMailBody' | translate }}"
            target="_blank"
            ibmLink
          >
            {{
              'account.links.plantATree' | translate
            }}
          </a>
        </ibm-list-column>
      </ibm-list-row>
    </ibm-structured-list>
  </div>
</ng-template>

<ng-template #languageSettingsTemplate>
  <ibm-structured-list>
    <ibm-list-header>
      <ibm-list-column>{{ 'settings.language.title' | translate }}</ibm-list-column>
    </ibm-list-header>
    <ibm-list-row>
      <ibm-list-column>
        <ibm-select
          [ngModel]="selectedLanguage$ | async"
          (ngModelChange)="updateUserLanguage($event)"
        >
          <option *ngFor="let lang of languageOptions$ | async" [value]="lang">
            {{ 'settings.language.options.' + lang | translate }}
          </option>
        </ibm-select>
      </ibm-list-column>
    </ibm-list-row>
  </ibm-structured-list>
</ng-template>

<ng-template #notificationSettingsTemplate>
  <ibm-structured-list *ngIf="emailNotificationSettingsWithSideEffects$ | async">
    <ibm-list-header>
      <ibm-list-column>{{ 'settings.notification.title' | translate }}</ibm-list-column>
    </ibm-list-header>
    <ibm-list-row>
      <ibm-list-column>
        <form [formGroup]="settingsForm" class="toggle-group">
          <ibm-toggle
            [label]="'settings.notification.taskNotifications' | translate"
            [onText]="'interface.on' | translate"
            [offText]="'interface.off' | translate"
            formControlName="taskNotifications"
            [disabled]="updatingSettings$ | async"
          >
          </ibm-toggle>
          <span class="description">{{
            'settings.notification.emailNotificationsIntro' | translate
          }}</span>
        </form>
      </ibm-list-column>
    </ibm-list-row>
    <ibm-list-row>
      <ibm-list-column>
        <form [formGroup]="settingsForm" class="toggle-group">
          <ibm-toggle
            [label]="'settings.notification.emailNotifications' | translate"
            [onText]="'interface.on' | translate"
            [offText]="'interface.off' | translate"
            formControlName="emailNotifications"
            [disabled]="updatingSettings$ | async"
          >
          </ibm-toggle>
          <span class="description">{{
            'settings.notification.taskNotificationsIntro' | translate
          }}</span>
        </form>
      </ibm-list-column>
    </ibm-list-row>
  </ibm-structured-list>
</ng-template>

<ng-template #versionTemplate>
  <ng-container *ngIf="{backendVersion: backendVersion$ | async} as obs">
    <ibm-structured-list *ngIf="obs.backendVersion">
      <ibm-list-header>
        <ibm-list-column>{{ 'settings.version.title' | translate }}</ibm-list-column>
      </ibm-list-header>
      <ibm-list-row>
        <ibm-list-column>
          <div class="build-information" *ngIf="obs.backendVersion">
            <span class="build-title">{{
              'interface.builds.' + obs.backendVersion.title | translate
            }}</span>
            <ibm-tag type="blue">{{ obs.backendVersion.version }}</ibm-tag>
          </div>
        </ibm-list-column>
      </ibm-list-row>
    </ibm-structured-list>
  </ng-container>
</ng-template>
