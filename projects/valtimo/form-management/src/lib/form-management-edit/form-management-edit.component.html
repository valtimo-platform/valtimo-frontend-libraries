<!--
  ~ Copyright 2015-2024 Ritense BV, the Netherlands.
  ~
  ~ Licensed under EUPL, Version 1.2 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~ https://joinup.ec.europa.eu/collection/eupl/eupl-text-eupl-12
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" basis,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->
<ng-container
  *ngIf="{
    formDefinition: formDefinition$ | async,
    jsonFormDefinition: jsonFormDefinition$ | async,
    jsonOutput: jsonOutput$ | async
  } as obs"
>
  @if (obs.formDefinition) {
    <ng-container renderInPageHeader [fullWidth]="true">
      <ng-template>
        <div class="valtimo-form-management-edit__header">
          <cds-overflow-menu [attr.data-carbon-theme]="CARBON_THEME">
            <cds-overflow-menu-option (selected)="downloadFormDefinition(obs.formDefinition)">
              {{ 'Download' | translate }}
            </cds-overflow-menu-option>

            <cds-overflow-menu-option
              [disabled]="obs.formDefinition.readOnly"
              (selected)="downloadFormDefinition(obs.formDefinition)"
            >
              {{ 'Upload' | translate }}
            </cds-overflow-menu-option>

            <cds-overflow-menu-option
              [disabled]="obs.formDefinition.readOnly"
              (selected)="delete(obs.formDefinition)"
            >
              {{ 'interface.delete' | translate }}
            </cds-overflow-menu-option>

            <cds-overflow-menu-option
              [disabled]="obs.formDefinition.readOnly"
              (selected)="showDuplicateModal(obs.formDefinition)"
            >
              {{ 'formManagement.duplicate' | translate }}
            </cds-overflow-menu-option>
          </cds-overflow-menu>

          <button
            cdsButton="primary"
            [disabled]="obs.formDefinition.readOnly || !validJsonChange"
            (click)="modifyFormDefinition(obs.formDefinition)"
          >
            {{ 'interface.save' | translate }}

            <svg class="cds--btn__icon" cdsIcon="save" size="16"></svg>
          </button>
        </div>
      </ng-template>
    </ng-container>

    <cds-tabs type="contained" [attr.data-carbon-theme]="CARBON_THEME">
      <cds-tab [heading]="TABS.BUILDER | translate" (selected)="onSelectedTab(TABS.BUILDER)">
        <valtimo-form-io-builder
          *ngIf="(reloading$ | async) === false && activeTab === TABS.BUILDER"
          [form]="obs.formDefinition.formDefinition"
          (change)="formBuilderChanged($event, obs.jsonFormDefinition)"
        ></valtimo-form-io-builder>
      </cds-tab>

      <cds-tab [heading]="TABS.EDITOR | translate" (selected)="onSelectedTab(TABS.EDITOR)">
        <valtimo-editor
          *ngIf="activeTab === TABS.EDITOR"
          [model]="obs.jsonFormDefinition"
          (validEvent)="onValidEvent($event)"
          (valueChangeEvent)="onValueChangeEvent($event, obs.formDefinition)"
          heightStyle="calc(100vh - 316px)"
        ></valtimo-editor>
      </cds-tab>

      <cds-tab
        [heading]="TABS.OUTPUT | translate"
        (selected)="onSelectedTab(TABS.OUTPUT)"
        class="valtimo-form-management-edit__output"
      >
        <valtimo-form-io
          [form]="obs.formDefinition.formDefinition"
          (change)="onOutputChange($event)"
        ></valtimo-form-io>

        <valtimo-editor
          *ngIf="activeTab === TABS.OUTPUT"
          [model]="obs.jsonOutput"
          [disabled]="true"
          heightStyle="calc(100vh - 316px)"
        ></valtimo-editor>
      </cds-tab>
    </cds-tabs>
  } @else {
    <valtimo-spinner></valtimo-spinner>
  }

  <valtimo-form-management-upload
    [show$]="showModal$"
    (definitionUploaded)="setFormDefinition($event)"
  ></valtimo-form-management-upload>

  <ng-template #jsonEditor let-data="data">
    <valtimo-editor
      [model]="data.model"
      [disabled]="data.disabled"
      (validEvent)="onValidEvent($event, data.disabled)"
      (valueChangeEvent)="onValueChangeEvent($event, obs.formDefinition, data.disabled)"
      heightStyle="calc(100vh - 316px)"
    ></valtimo-editor>
  </ng-template>
</ng-container>
